name: Deploy to CloudBase

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install CloudBase CLI
        run: npm install -g @cloudbase/cli

      - name: Install function dependencies
        run: |
          echo "=== Installing annotations dependencies ==="
          cd functions/annotations && npm install && ls -la
          echo "=== Installing translate dependencies ==="
          cd ../translate && npm install && ls -la
          echo "=== Installing setup-db dependencies ==="
          cd ../setup-db && npm install && ls -la

      - name: Debug - Check directory structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Root directory contents ==="
          ls -la
          echo "=== Functions directory ==="
          ls -la functions/
          echo "=== Annotations function files ==="
          ls -la functions/annotations/
          echo "=== Annotations index.js exists? ==="
          cat functions/annotations/index.js | head -20
          echo "=== Setup-db function files ==="
          ls -la functions/setup-db/
          echo "=== Translate function files ==="
          ls -la functions/translate/

      - name: Create CloudBase config
        run: |
          echo "=== Creating cloudbaserc.json ==="
          cat > cloudbaserc.json << EOF
          {
            "envId": "${{ secrets.TCB_ENV_ID }}",
            "version": "2.0",
            "functionRoot": "functions",
            "functions": [
              {
                "name": "translate",
                "config": {
                  "runtime": "Nodejs16.13",
                  "handler": "index.main",
                  "timeout": 10,
                  "memorySize": 256,
                  "envVariables": {
                    "TENCENT_SECRET_ID": "${{ secrets.TENCENT_SECRET_ID }}",
                    "TENCENT_SECRET_KEY": "${{ secrets.TENCENT_SECRET_KEY }}"
                  }
                }
              },
              {
                "name": "annotations",
                "config": {
                  "runtime": "Nodejs16.13",
                  "handler": "index.main",
                  "timeout": 10,
                  "memorySize": 256,
                  "envVariables": {
                    "MYSQL_HOST": "${{ secrets.MYSQL_HOST }}",
                    "MYSQL_PORT": "3306",
                    "MYSQL_USER": "${{ secrets.MYSQL_USER }}",
                    "MYSQL_PASSWORD": "${{ secrets.MYSQL_PASSWORD }}",
                    "MYSQL_DATABASE": "${{ secrets.TCB_ENV_ID }}"
                  }
                }
              },
              {
                "name": "setup-db",
                "config": {
                  "runtime": "Nodejs16.13",
                  "handler": "index.main",
                  "timeout": 30,
                  "memorySize": 256,
                  "envVariables": {
                    "MYSQL_HOST": "${{ secrets.MYSQL_HOST }}",
                    "MYSQL_PORT": "3306",
                    "MYSQL_USER": "${{ secrets.MYSQL_USER }}",
                    "MYSQL_PASSWORD": "${{ secrets.MYSQL_PASSWORD }}",
                    "MYSQL_DATABASE": "${{ secrets.TCB_ENV_ID }}"
                  }
                }
              }
            ]
          }
          EOF
          echo "=== cloudbaserc.json contents ==="
          cat cloudbaserc.json
          echo "=== Validating JSON ==="
          cat cloudbaserc.json | python3 -m json.tool || echo "JSON validation failed!"

      - name: Login to CloudBase
        run: |
          echo "=== Logging in to CloudBase ==="
          tcb login --apiKeyId ${{ secrets.TENCENT_SECRET_ID }} --apiKey ${{ secrets.TENCENT_SECRET_KEY }}
          echo "=== Login successful ==="

      - name: Deploy annotations function
        run: |
          echo "=== Deploying annotations function ==="
          tcb fn deploy annotations --force || echo "Annotations deploy failed!"

      - name: Deploy translate function
        run: |
          echo "=== Deploying translate function ==="
          tcb fn deploy translate --force || echo "Translate deploy failed!"

      - name: Deploy setup-db function
        run: |
          echo "=== Deploying setup-db function ==="
          tcb fn deploy setup-db --force || echo "Setup-db deploy failed!"

      - name: Run setup-db to update MySQL schema
        run: |
          echo "=== Running setup-db function to add missing columns ==="
          tcb fn invoke setup-db -e ${{ secrets.TCB_ENV_ID }}
          echo "=== Setup-db function executed ==="

      - name: Deploy static files
        run: |
          echo "=== Deploying static files ==="
          mkdir -p dist
          cp *.html dist/
          cp -r lib dist/
          echo "=== Dist directory contents ==="
          ls -la dist/
          # Retry up to 3 times due to transient network issues
          for i in 1 2 3; do
            echo "=== Attempt $i to deploy static files ==="
            if tcb hosting deploy ./dist / -e ${{ secrets.TCB_ENV_ID }}; then
              echo "=== Static files deployed successfully ==="
              exit 0
            fi
            echo "=== Attempt $i failed, waiting 10 seconds before retry ==="
            sleep 10
          done
          echo "=== All attempts failed ==="
          exit 1
